# Stability Case Review: Dialog-Level Контракт

## Контекст

В предыдущих итерациях в продукте накопилась техвариативность:
- режимные флаги scan;
- разные варианты покрытия judge;
- режимы хранения LLM trace.

Технически это ускоряло эксперименты, но с точки зрения бизнес-контракта выглядело как «флюгер»: при каждом изменении было неочевидно, что именно является стабильной продуктовой нормой.

## Почему это выглядело как костыли

1. Одни и те же метрики могли интерпретироваться по-разному в зависимости от флагов запуска.
2. В C-level контуре появлялись инженерные параметры, не добавляющие ценности управленческому чтению отчета.
3. Минимальный trace в части запусков ухудшал аудит и разбор инцидентов.

## Что зафиксировано в v5

Продуктовый режим теперь один:
- bundled evaluator + bundled judge для каждого диалога;
- `greeting` считается только в первых 3 сообщениях продавца;
- `upsell` и `empathy` считаются по всему диалогу с политикой any-occurrence;
- judge coverage всегда 100%;
- контекст всегда полный;
- LLM trace всегда полный.

Эта фиксация убирает вариативность, которая не нужна для C-level отчетности.

## Зачем это бизнесу

- Единая интерпретация качества переписок между командами.
- Прозрачный аудит решений модели и judge без потерь данных.
- Снижение операционного шума при подготовке отчетности.
- Прямая привязка качества коммуникаций к удержанию клиентов (`retention`).

## Допустимые термины и где они определены

- Термины бизнес-правил и порогов: [`src/dialogs/sgr_core.py`](../src/dialogs/sgr_core.py)
- Техническая реализация независимого judge-слоя: [`src/dialogs/judge/`](../src/dialogs/judge/)
- Термины схемы и полей БД: [`src/dialogs/db.py`](../src/dialogs/db.py)
- Контракт запуска и интерпретации: [`README.md`](../README.md)
- Визуальная интерпретация для руководства: [`notebooks/sgr_quality_demo.ipynb`](../notebooks/sgr_quality_demo.ipynb)

## Правило изменений

Любой новый термин или политика исполнения добавляются одновременно в doc-contract точки:
- `README.md`
- `src/dialogs/sgr_core.py`
- `docs/judge_module.md`
- `tests/test_platform_dataset_style.py`
- `notebooks/sgr_quality_demo.ipynb`
- `artifacts/metrics.md`
- `artifacts/accuracy_diff.png`
- `Makefile`
- этот файл `docs/stability_case_review.md`
